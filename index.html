<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VoenPolMap</title>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    
    #date-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 8px 16px;
      border-radius: 10px;
      z-index: 10;
      font-family: Arial;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #current-date {
      font-size: 16px;
      font-weight: bold;
    }
    
    .nav-button {
      font-size: 20px;
      cursor: pointer;
      background: none;
      border: none;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
      transition: background 0.2s;
    }
    
    .nav-button:hover {
      background: rgba(0,0,0,0.1);
    }
    
    #left-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .control-button {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    
    .control-button:hover {
      transform: scale(1.1);
    }
    
    #notifications-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      background: white;
      border-radius: 15px;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 2px solid #ddd;
    }
    
    #notifications-header {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #eee;
      background: #f8f8f8;
      text-align: center;
    }
    
    #notifications-content {
      padding: 15px;
      overflow-y: auto;
      flex-grow: 1;
    }
    
    .update-container {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0;
      margin-bottom: 15px;
      overflow: hidden;
    }
    
    .update-header {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
    }
    
    .update-date {
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }
    
    .update-time {
      font-size: 14px;
      color: #666;
    }
    
    .update-text {
      padding: 12px 15px;
      line-height: 1.5;
    }
    
    .city-link {
      color: #1a73e8;
      cursor: pointer;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.2s;
    }
    
    .city-link:hover {
      color: #0d5bba;
      text-decoration: underline;
    }
    
    #close-notifications {
      padding: 12px;
      background: #f8f8f8;
      border-top: 1px solid #eee;
      text-align: center;
      cursor: pointer;
      color: #1a73e8;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    #close-notifications:hover {
      background: #f0f0f0;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
      display: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #settings-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 400px;
      background: white;
      border-radius: 15px;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 2px solid #ddd;
    }
    
    #settings-header {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #eee;
      background: #f8f8f8;
      text-align: center;
    }
    
    #settings-content {
      padding: 20px;
    }
    
    .map-style-option {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .map-style-option:hover {
      background-color: #f5f5f5;
    }
    
    .map-style-option.selected {
      background-color: #e3f2fd;
      border-color: #1a73e8;
    }
    
    .style-radio {
      margin-right: 12px;
    }
    
    .style-info {
      flex-grow: 1;
    }
    
    .style-name {
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .style-description {
      font-size: 12px;
      color: #666;
    }
    
    #close-settings {
      padding: 12px;
      background: #f8f8f8;
      border-top: 1px solid #eee;
      text-align: center;
      cursor: pointer;
      color: #1a73e8;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    #close-settings:hover {
      background: #f0f0f0;
    }
    
    @media (max-width: 768px) {
      #date-container {
        top: auto;
        bottom: 20px;
        width: auto;
      }
      
      #left-controls {
        top: 15px;
        left: auto;
        right: 15px;
        flex-direction: row;
      }
      
      .control-button {
        width: 40px;
        height: 40px;
      }
      
      #notifications-panel,
      #settings-panel {
        width: 95%;
      }
      
      .update-header {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>

<div id="date-container">
  <button class="nav-button" id="prev-btn">&lt;</button>
  <span id="current-date">20.05.2025</span>
  <button class="nav-button" id="next-btn">&gt;</button>
  <button class="nav-button" id="compare-btn">&gt;&lt;</button>
</div>

<div id="left-controls">
  <button id="settings-btn" class="control-button" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
  <button id="info-btn" class="control-button" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">i</button>
  <button id="notifications-btn" class="control-button" title="–û–±–Ω–æ–≤–ª–µ–Ω–∏—è">üîî</button>
  <button id="tg-channel-btn" class="control-button" title="Telegram-–∫–∞–Ω–∞–ª">üì¢</button>
</div>

<div class="overlay" id="notifications-overlay"></div>
<div id="notifications-panel">
  <div id="notifications-header">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã</div>
  <div id="notifications-content"></div>
  <div id="close-notifications">–ó–∞–∫—Ä—ã—Ç—å</div>
</div>

<div class="overlay" id="settings-overlay"></div>
<div id="settings-panel">
  <div id="settings-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã</div>
  <div id="settings-content">
    <div class="map-style-option selected" data-style="basic">
      <input type="radio" name="map-style" class="style-radio" checked>
      <div class="style-info">
        <div class="style-name">–ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞</div>
        <div class="style-description">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å —Ü–≤–µ—Ç–æ–≤—ã–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π</div>
      </div>
    </div>
    
    <div class="map-style-option" data-style="topographic">
      <input type="radio" name="map-style" class="style-radio">
      <div class="style-info">
        <div class="style-name">–¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è</div>
        <div class="style-description">–ö–∞—Ä—Ç–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ä–µ–ª—å–µ—Ñ–∞ –∏ –≤—ã—Å–æ—Ç</div>
      </div>
    </div>
    
    <div class="map-style-option" data-style="satellite">
      <input type="radio" name="map-style" class="style-radio">
      <div class="style-info">
        <div class="style-name">–°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</div>
        <div class="style-description">–°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ —Å–Ω–∏–º–∫–∏ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏</div>
      </div>
    </div>
  </div>
  <div id="close-settings">–ó–∞–∫—Ä—ã—Ç—å</div>
</div>

<div id="map"></div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://api.maptiler.com/maps/01966ded-9a2b-7a36-bad5-71bc7e8b2bf7/style.json?key=A7YSMrQ3OZ0oStEWILkD',
  center: [31.1656, 48.3794],
  zoom: 6,
  touchZoomRotate: true,
  interactive: true
});

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫–∞—Ä—Ç—ã
const mapStyles = {
  basic: 'https://api.maptiler.com/maps/01966ded-9a2b-7a36-bad5-71bc7e8b2bf7/style.json?key=A7YSMrQ3OZ0oStEWILkD',
  topographic: 'https://api.maptiler.com/maps/outdoor/style.json?key=A7YSMrQ3OZ0oStEWILkD',
  satellite: 'https://api.maptiler.com/maps/hybrid/style.json?key=A7YSMrQ3OZ0oStEWILkD'
};

// –î–∞–Ω–Ω—ã–µ –ø–æ–ª–∏–≥–æ–Ω–æ–≤
const idToName = {
  "80c27733-0eea-4845-93f5-e8938d4a79b3": "–ö—Ä—ã–º",
  "5cdb851b-4447-41b6-ae6f-a134e8b00236": "–õ–î–ù–†"
};

const occupiedIds = [
  "22b8b8e8-394b-4625-b388-19cbdd597de5",
  "e7756804-6807-44a9-8110-c6ab01dda52a",
  "ffe28d26-b43a-4d92-8ffc-b1f8c4f182a5",
  "18ed4fb6-c145-478f-baee-efa28b2601a5",
  "38be1fbf-fcb2-422e-a4e5-96010a2dc6e2",
  "c22a11ea-d574-4375-9e40-01cc2ddaaba6",
  "259453df-e959-446e-92c5-f5d38366827b",
  "6146b2fb-45c0-4234-a4ac-04d0e1bea555",
  "0af67c7e-2f75-4c7a-8db6-b83eebb4c107",
  "9e30e9e9-67f4-4447-9e40-283538ff1250",
  "c09bbc86-d3fd-4225-ad9b-6bca871b338c",
  "8c09bf03-41d8-4b1e-9eb8-54deb6b8d70c",
  "c7f8d7a7-3591-4ccb-b79d-31aadd268566",
  "0ff327a9-09f1-4d07-b6e8-bc36c4ccad38",
  "87e43fec-1baa-405d-837d-51900e25a865",
  "e3bdd016-4109-4ac5-aab6-9e6e6996ad6f",
  "4d58bb84-3cc3-4e63-8a9e-600a88a20305",
  "90d48529-8056-4752-87a6-f6e3698452cb",
  "48a19fb9-3d32-4982-b55f-83d26bdc1c8b",
  "d93d7bb9-c419-42e6-add2-7faba4c368d0",
];
  
const liberatedIds = ["e1682ab0-a5db-47fd-98b1-9be95133d6e6",
                      "107222fd-2dbb-49e3-9693-a40737340c18",
                      "c9029fec-8fc3-4fcd-80c6-678e1d71da0d",
                      "6337c438-542b-4387-a40d-dbcdb5362bfd",
                      "13e0fc24-d6d3-4ae7-a93c-b6cbfbe8deb7",
                      "1037909f-1479-4103-94f6-5a42c6d943c9",
                      "c7d0c0b1-8f1d-4691-9ce3-b9cd3f1c11d0",
                      "825b5b8e-cebe-496f-923f-8a3654b0363f",
                      "4e02830e-78c0-4768-add8-b93915b47c21",
                      "20269126-34a1-42fc-a183-75cf90f0ed82",
                      "67306007-39bd-40f7-b758-1664d6850f65",
                      "8b88004e-83bf-4c68-9945-60833893b3ff",
                      "13608cb0-8f5f-4c05-aacd-74c2411e509c",
                      "8fd587aa-7b7c-4226-836f-f9a7f9c15f53",
                      "91aed115-47ff-4732-a827-149abf28d376",
                      "340b4db1-70a6-4007-b632-81bf9a6b49f1",
                      "bb430ebf-7e66-4a56-90dc-e78cd66db7f7",
                      "0b44a306-bdff-4ecf-af13-34895ae58171",
                      "d753c677-c9fe-409a-971a-a953b507e1be",
                      "bf03b2eb-dabd-4368-b951-87e0d2754bd7",
                     ];

const newLiberatedIds = [
  "418a53e5-49e1-4ba5-b451-c0e4f733d734",
  "17e912ab-8e25-4bc9-b8f3-762bbd51e091",
  "1c4aff4e-d285-44d5-8fa1-c72a596f4d59",
  "5355500b-cbb9-44e0-9d51-711a77b5cf88",
  "8f9456f1-190b-436f-9909-3acd4860a477",
  "3d029f3c-2386-4669-b25e-63e095fa41a0",
  "67987403-7883-42dc-9d1d-67c07201c4a1",
  "05c73b06-5cdb-4682-8bdc-addbcc7ea942",
  "7b53cfba-7daf-46e4-acf9-d7887238d7f3",
  "223f7858-a5e8-48a5-ab37-f6d5d1730c72",
  "c35233d7-7e84-48e8-97a3-9eafbb5564fd",
  "bd0b2d90-7876-44b2-9fa4-a88bac1470dd",
  "0d093787-50b9-44c0-89bf-8a37159a2e3a",
  "622e8f29-dbbd-4a82-9a9d-4a44bfc18508",
  "5786b949-03f9-4905-ab8d-ee567b0d5609",
  "7e583cc6-66e8-471f-a714-cd27d434f502",
  "6d0eb43b-b2d7-43d4-be90-843e960bbd33",
  "e85b0388-d74b-4afa-aacc-a8dfe808566e",
  "00c2c646-dab5-4a76-b981-b9b37951844e",
  "c5b0a0cb-3b25-4fc8-a31f-716bc5f2ddc2",
  "77d858b3-c2da-4d3f-897e-22b93ad60865",
  "fe02e45c-ff52-4d13-96f9-011418e2b5b4",
  "192567e1-e846-44a2-b7b9-120f8534ac80",
  "c3d60a66-ef4f-4431-abcd-f944e3c9fcdd",
  "0ae4a1c0-0f6e-4ea3-a588-d051cc8f9c5e",
  "c40edaaf-8210-4168-816c-f252df0bbd11",
  "a1afe8fc-ab63-4f99-bd83-3e286ec5475f",
  "643d318e-d5fc-456d-93fb-dd9d7cecdbd0",
  "2cf3500f-867a-4846-a2f1-095ceecadb1f",
  "c588e5ae-3233-4a0f-a019-12d7953f79ef",
  "79fae843-9bbc-4532-8dca-17ed7822ca29",
  "4a635846-b315-4ef6-ba1e-728b5eb76d98",
  "31caf44b-632b-476a-8bf0-93bf9d45e9e8",
  "62cd1f77-9467-459a-a489-39fd03034cac",
  "1bea946c-d720-4842-bb4f-3c1576f9a3ec",
  "14f624ef-2e2d-4f1a-9c2a-32e252fdbfeb",
  "a74cd8d9-0994-4fab-82e7-14146f3a5d9a",
  "1d234475-4fd9-466b-9f69-4e59e02ba756",
  "5bf99d3e-af7a-460e-a9e8-5965c7e86959",
  "c7bf8dae-1b72-48f4-aa51-d62e31f32268",
  "3e3812f1-6b76-4599-8877-7eee51b14dd8",
  "6ee17f5e-4f2e-4cac-9d68-a669a35b556b",
  "6dc44775-c39f-4928-acb5-c194397d07c8",
  "7a7efc17-c569-46e0-8ad9-3acea3152f2e",
  "2cdb7a21-da5a-4393-8972-91c4b30739a4",
  "747b8f95-8c3d-40b3-a806-a2a3ea96f78f",
  "c3527e63-cca7-49bb-bc17-13bbf6f6ba9b",
  "30085aba-f8b3-4707-abcf-c62e41f8a638",
  "923a92e7-d3da-4f0f-9dce-2b2e1f248122",
  "5785b561-9f2b-4b95-a432-0a02ae5f78e5",
  "de995a6e-b94f-4a7d-a095-22a54a9ad1bb",
  "2a62b2ef-fd00-40d4-8b4f-e87b58c35435",
  "0d3046d1-b7cf-4e72-938c-a51d03fff089",
  "e9a35c93-e8c7-45d6-9f47-c6c48c02e6a0",
];

const liberatedRus = [
  "bbd7ed2a-b335-41b1-a9b8-efdc07385c52",
  "b67f94f4-3b24-4205-b44b-4ef3c33f70c7",
  "a9ffd521-0412-4c0c-bc97-f9f257b38d1c",
];
  
const availableDates = ["20.05.2025_23-10", 
                        "21.05.2025_23-56",
                        "22.05.2025_23-36",
                        "23.05.2025_23-48",
                        "24.05.2025_23-06",
                        "25.05.2025_23-39",
                        "26.05.2025_23-27",
                        "27.05.2025_23-15",
                        "28.05.2025_23-20",
                        "29.05.2025_23-58",
                        "30.05.2025_23-58",
                        "31.05.2025_23-34",
                        "01.06.2025_22-40",
                        "02.06.2025_21-53",
                        "03.06.2025_23-43",
                        "04.06.2025_22-44",
                        "05.06.2025_23-10",
                        "06.06.2025_21-37",
                        "07.06.2025_23-12",
                        "08.06.2025_21-45",
                        "09.06.2025_22-35",
                        "10.06.2025_23-13",
                        "11.06.2025_23-11",
                        "12.06.2025_23-10",
                        "13.06.2025_23-52",
                        "14.06.2025_23-52",
                        "15.06.2025_23-00",
                        "16.06.2025_23-26",
                        "17.06.2025_23-45",
                        "18.06.2025_23-40",
                        "19.06.2025_23-19",
                        "20.06.2025_23-33",
                        "21.06.2025_20-59",
                        "22.06.2025_13-52",
                        "23.06.2025_18-50",
                        "24.06.2025_00-18",
                        "25.06.2025_00-50",
                        "26.06.2025_09-13",
                        "27.06.2025_11-08",
                        "28.06.2025_23-48",
                        "29.06.2025_23-42",
                        "30.06.2025_23-07",
                        "01.07.2025_23-15",
                        "02.07.2025_23-22",
                        "03.07.2025_22-58",
                        "04.07.2025_23-39",
                        "05.07.2025_23-34",
                        "06.07.2025_23-06",
                        "07.07.2025_23-23",
                        "08.07.2025_23-46",
                        "09.07.2025_23-27",
                        "10.07.2025_23-27",
                        "11.07.2025_23-44",
                        "12.07.2025_23-44",
                        "13.07.2025_22-17",
                        "14.07.2025_23-11",
                        "15.07.2025_23-24",
                        "16.07.2025_23-18",
                        "17.07.2025_23-13",
                        "18.07.2025_23-08",
                        "19.07.2025_23-50",
                        "20.07.2025_22-58",
                        "21.07.2025_22-49",
                        "22.07.2025_22-22",
                        "23.07.2025_23-11",
                        "24.07.2025_23-45",
                        "25.07.2025_23-37",
                        "26.07.2025_23-54",
                        "27.07.2025_23-01",
                        "28.07.2025_23-46",
                        "29.07.2025_23-30",
                        "30.07.2025_23-53",
                        "31.07.2025_22-22",
                        "01.08.2025_22-52",
                        "02.08.2025_23-20",
                        "03.08.2025_23-58",
                        "04.08.2025_22-57",
                        "05.08.2025_22-22",
                        "06.08.2025_22-44",
                        "07.08.2025_23-53",
                        "08.08.2025_23-50",
                        "09.08.2025_23-09",
                        "10.08.2025_23-00",
                        "11.08.2025_19-17",
                        "12.08.2025_23-24",
                        "13.08.2025_22-34",
                        "14.08.2025_23-21",
                        "15.08.2025_19-37",
                        "16.08.2025_17-27",
                        "17.08.2025_19-32",
                        "18.08.2025_22-53",
                        "19.08.2025_23-09",
                        "20.08.2025_23-52",
                        "21.08.2025_23-01",
                        "22.08.2025_22-18",
                        "23.08.2025_23-01",
                        "24.08.2025_12-15",
                        "24.08.2025_17-05",
                        "25.08.2025_20-20",
                        "26.08.2025_16-30",
                        "27.08.2025_18-50",
                        "28.08.2025_21-30",
                        "31.08.2025_19-35",
                        "04.09.2025_21-30",
                        "07.09.2025_15-20",
                        "10.09.2025_18-10",
                       ];

const updates = [
  {
    date: "31 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "19:35",
    changes: [
      {
        text: "–í–°–£ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ ",
        city: "–ù–æ–≤–æ—ç–∫–æ–Ω–æ–º–∏—á–Ω–æ–≥–æ ",
        coords: [37.33702262937965, 48.322925603004705],
        zoom: 12
      },
      {
        text: "–í–°–†–§ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ —Ä–∞–π–Ω–µ  ",
        city: "–ú–∏—Ö–∞–π–ª–æ–≤–∫–µ ", 
        coords: [ 37.37548828125001, 48.291645360378894],
        zoom: 12
      },
      {
        text: ",  ",
        city: "–ó–∞—Ä–µ—á–Ω–æ–≥–æ ", 
        coords: [ 37.94222831726075, 49.01586261490659],
        zoom: 12
      },
      {
        text: "–∏  ",
        city: "–ù–æ–≤–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏ ", 
        coords: [ 37.19266891479493, 48.22850365880973],
        zoom: 12
      },
      {
        text: "—Ç–∞–∫ –∂–µ –æ–∫–∫—É–ø–∏—Ä–æ–≤–∞–ª–∏ ",
        city: "–ö–æ–º—ã—à–æ–≤–∫—É", 
        coords: [36.59408569335938, 47.889643549802905],
        zoom: 12
      },
      {
        text: "–í–°–£ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤–æ–∑–ª–µ ",
        city: "–ù–æ–≤–æ—Å–µ–ª–∫–µ", 
        coords: [36.53263092041016, 47.962226637072604],
        zoom: 12
      },
      {
        text: ", ",
        city: "–ú–∏—Ä–Ω–æ–º", 
        coords: [37.57719039916993, 49.73535331279718],
        zoom: 12
      },
    ]
  },
  {
    date: "28 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "21:30",
    changes: [
      {
        text: "–í–°–£ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ ",
        city: "–ú–æ—Å–∫–æ–≤–∫–µ –∏ –°–æ–±–æ–ª–∏–≤–∫–µ ",
        coords: [37.572040557861335, 49.729028863554575],
        zoom: 12
      },
      {
        text: "–í–°–†–§ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ —Ä–∞–π–Ω–µ  ",
        city: "–®–∞–Ω–¥—Ä—ã–ª–æ–≥–æ–≤–æ–≥–æ –∏ –î–µ—Ä–∏–ª–æ–≤–æ–≥–æ ", 
        coords: [ 37.76292800903321, 49.13354249681642],
        zoom: 12
      },
      {
        text: "–∏ –≤ ",
        city: "–ù–æ–≤–æ—Å–µ–ª–∫–µ", 
        coords: [36.53396129608155, 47.962226637072604],
        zoom: 12
      },
    ]
  },
  {
    date: "27 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "18:50",
    changes: [
      {
        text: "–í–°–£ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ ",
        city: "–ú–∞–ª–∏–Ω–æ–≤–∫–µ  ",
        coords: [36.467399597167976, 47.67902719206281],
        zoom: 12
      },
      {
        text: "–í–°–†–§ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ —Ä–∞–π–Ω–µ  ",
        city: "–ó–∞—Ä–µ—á–Ω–æ–≥–æ ", 
        coords: [37.95544624328614, 49.02188550114461],
        zoom: 12
      },
      {
        text: ", ",
        city: "–ö–æ—Ç–ª–∏–Ω–æ", 
        coords: [37.05164909362794, 48.25354110233028],
        zoom: 12
      },
      {
        text: ", ",
        city: "–ö–æ–ª–æ–¥–µ–∑–∏–π", 
        coords: [37.05164909362794, 48.25354110233028],
        zoom: 12
      },
      {
        text: ", ",
        city: "–û–ª—å–≥–æ–≤—Å–∫–æ–µ ", 
        coords: [36.53348922729493, 47.76286842503948],
        zoom: 12
      },
      {
        text: "–¢–∞–∫ –∂–µ –≤–æ–∑–ª–µ ",
        city: "–ó–≤–µ—Ä–æ–≤–æ–≥–æ ", 
        coords: [37.121000289917, 48.24348186718447],
        zoom: 12
      },
      {
        text: ", ",
        city: "–¢–µ—Ä–º–∏–Ω–æ–≤–∫–∏ ", 
        coords: [36.56893730163575, 47.81765021489975],
        zoom: 12
      },
      {
        text: "–∏ ",
        city: "–ú–∞–ª–∏–µ–≤–∫–∏ ", 
        coords: [36.63408279418946, 47.913580765920166],
        zoom: 12
      },
    ]
  },
  {
    date: "26 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "16:30",
    changes: [
      {
        text: "–í–°–£ –û—Å–≤–æ–±–æ–¥–∏–ª–∏ ",
        city: "–ù–∏–∫–æ–ª–∞–µ–≤–∫—É  ",
        coords: [37.352472153305435, 48.33034436269049],
        zoom: 12
      },
      {
        text: "–∏ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤–æ–∑–ª–µ  ",
        city: "–ù–æ–≤–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ ", 
        coords: [37.33702262937965, 48.322925603004705],
        zoom: 12
      },
      {
        text: "–í–°–†–§ –æ–∫–∫—É–ø–∏—Ä–æ–≤–∞–ª–∏ ",
        city: "–ó–∞–ø–æ—Ä–æ–∂—Å–∫–æ–µ", 
        coords: [36.53194427490235, 47.85256506621191],
        zoom: 12
      },
      {
        text: " –∏ ",
        city: "–ù–æ–≤–æ–µ–≥–æ—Ä–æ–≤–∫—É", 
        coords: [36.56661987304688, 47.86730751600374],
        zoom: 12
      },
      {
        text: " –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤–æ–∑–ª–µ ",
        city: "–®–µ–≤—á–µ–Ω–∫–∞ ", 
        coords: [36.65708541870118, 47.91220007354159],
        zoom: 12
      },
      {
        text: " –∏ –≤–æ–∑–ª–µ ",
        city: "–ë–µ–ª–æ–π –≥–æ—Ä—ã, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ-–®—É–ª—å—Ç–∏–Ω–æ ", 
        coords: [37.84510796867557, 48.47638365163363],
        zoom: 12
      },
    ]
  },
  {
    date: "25 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "20:20",
    changes: [
      {
        text: "–í–°–£ –û—Å–≤–æ–±–æ–¥–∏–ª–∏ ",
        city: "–ì—Ä–µ–∫–æ–≤–∫—É ",
        coords: [37.918796662941304, 49.2429401964201],
        zoom: 12
      },
      {
        text: "–í–°–†–§ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤–æ–∑–ª–µ  ",
        city: "–£–¥–∞—á–Ω–æ–≥–æ ", 
        coords: [36.987018585205085, 48.23690800267914],
        zoom: 12
      },
      {
        text: "–∏ ",
        city: "–°–æ–±–æ–ª–µ–≤–∫–∏", 
        coords: [37.571525573730476, 49.72259261311294],
        zoom: 12
      },
    ]
  },
  {
    date: "24 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "17:05",
    changes: [
      {
        text: "–í–°–£ –û—Å–≤–æ–±–æ–¥–∏–ª–∏ ",
        city: "–ú–∏—Ö–∞–π–ª–æ–≤–∫—É ",
        coords: [37.36484527587891, 48.302380258156205],
        zoom: 12
      },
      {
        text: "–∏ ",
        city: "–ù–æ–≤–æ–º–∏—Ö–∞–π–ª–æ–≤–∫—É ", 
        coords: [37.87476539611817, 49.201392074072935],
        zoom: 12
      },
      {
        text: "–ü—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤ —Ä–∞–π–æ–Ω–µ ",
        city: "–†–µ–¥–∫–æ–¥—É–±–∞", 
        coords: [37.803908290224214, 49.18079416470714],
        zoom: 12
      },
      {
        text: "–£—Ç–æ—á–Ω–µ–Ω–∏–µ –≤ —Ä–∞–π–æ–Ω–µ ",
        city: "–î–∞—á", 
        coords: [32.65171051025391, 46.63364346877216],
        zoom: 12
      },
    ]
  },
  {
    date: "24 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "12:15",
    changes: [
      {
        text: "–í–°–£ –û—Å–≤–æ–±–æ–¥–∏–ª–∏ ",
        city: "–ó–µ–ª–µ–Ω—ã–π –≥–∞–π ",
        coords: [36.66008949279786, 48.068157307908],
        zoom: 12
      },
      {
        text: "–∏ ",
        city: "–¢–æ–ª—Å—Ç–æ–π ", 
        coords: [36.68669700622559, 48.03843831164194],
        zoom: 12
      },
      {
        text: "–ò–¥—É—Ç –±–æ–∏ –≤ —Ä–∞–π–æ–Ω–µ ",
        city: "–ú–∏—Ä–Ω–æ–≥–æ –∏ –ú–∞–ª–∏–Ω–æ–≤–∫–∏", 
        coords: [37.38702574717745, 48.33589950209235],
        zoom: 12
      },
    ]
  },
  {
    date: "23 –∞–≤–≥—É—Å—Ç–∞ 2025",
    time: "23:01",
    changes: [
      {
        text: "–í–°–£ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤–æ–∑–ª–µ ",
        city: "–ê–Ω–¥—Ä–µ–µ–≤–∫–∏",
        coords: [34.82528686523438, 51.14677888596036],
        zoom: 12
      },
      {
        text: "–í–°–†–§ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –≤–æ–∑–ª–µ ",
        city: "–í–æ–ª—å–Ω–æ–≥–æ –ü–æ–ª—è ", 
        coords: [36.63631439208985, 47.87836160225798],
        zoom: 12
      },
      {
        text: "–∏ –≤–æ–∑–ª–µ ",
        city: "–ö–∞–º–µ–Ω—Å–∫–æ–≥–æ", 
        coords: [35.39142608642579, 47.55503973892605],
        zoom: 12
      },
      {
        text: ", ",
        city: "–ü–ª–∞–≤–Ω—è—Ö", 
        coords: [35.336580276489265, 47.56193242677904],
        zoom: 12
      },
    ]
  }
];

let currentIndex = availableDates.length - 1;
let currentGeojson = null;
let previousDateGeojson = null;
let compareActive = false;
let currentMapStyle = 'basic';

function formatArea(area) {
  return (area / 1e6).toFixed(2) + ' –∫–º¬≤';
}

async function loadMap(dateStr, isPrevious = false) {
  const url = `https://vleddd.github.io/DeepMap/maps/map_${dateStr}.geojson`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      if (response.status === 404) {
        console.warn("–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return null;
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const geojson = await response.json();
    
    if (isPrevious) {
      return geojson;
    } else {
      processGeoJSON(geojson);
      return geojson;
    }
    
  } catch (err) {
    console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ GeoJSON:", err.message);
    return null;
  }
}

function processGeoJSON(geojson) {
  currentGeojson = geojson;

  geojson.features.forEach(f => {
    const id = f.id || f.properties.id;
    if (idToName[id]) {
      f.properties.customName = idToName[id];
      f.properties.fillColor = "#b57edc";
    } else if (occupiedIds.includes(id)) {
      f.properties.customName = "–û–∫–∫—É–ø–∏—Ä–æ–≤–∞–Ω–æ";
      f.properties.fillColor = "#d22b2b";
    } else if (newLiberatedIds.includes(id)) {
      f.properties.customName = "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ";
      f.properties.fillColor = "#5BC779";
    } else if (liberatedIds.includes(id)) {
      f.properties.customName = "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ";
      f.properties.fillColor = "#3498db";
    } else if (liberatedRus.includes(id)) {
      f.properties.customName = "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ";
      f.properties.fillColor = "#1637CC";
    } else {
      f.properties.customName = "–ü–æ–¥ –í–æ–ø—Ä–æ—Å–æ–º";
      f.properties.fillColor = "#777";
    }
    f.properties.areaFormatted = formatArea(turf.area(f));
  });

  updateMapSource(geojson);
}

function updateMapSource(geojson) {
  if (map.getSource('war-zones')) {
    map.getSource('war-zones').setData(geojson);
  } else {
    map.addSource('war-zones', { type: 'geojson', data: geojson });
    map.addLayer({
      id: 'war-polygons',
      type: 'fill',
      source: 'war-zones',
      paint: {
        'fill-color': ['get', 'fillColor'],
        'fill-opacity': 0.5
      }
    });

    map.addLayer({
      id: 'war-outlines',
      type: 'line',
      source: 'war-zones',
      paint: {
        'line-color': ['get', 'fillColor'],
        'line-width': 1
      }
    });

    map.on('click', 'war-polygons', (e) => {
      const f = e.features[0];
      new maplibregl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`<h3>${f.properties.customName}</h3><p>–ü–ª–æ—â–∞–¥—å: ${f.properties.areaFormatted}</p>`)
        .addTo(map);
    });
  }
}

async function loadCurrentDate() {
  const dateStr = availableDates[currentIndex];
  document.getElementById('current-date').textContent = dateStr.split('_')[0];
  
  if (currentIndex > 0) {
    const prevDateStr = availableDates[currentIndex - 1];
    previousDateGeojson = await loadMap(prevDateStr, true);
  } else {
    previousDateGeojson = null;
  }
  
  await loadMap(dateStr);
}

function toggleCompare() {
  compareActive = !compareActive;
  
  if (compareActive && previousDateGeojson && currentGeojson) {
    showComparison();
  } else {
    removeComparisonLayers();
  }
}

function removeComparisonLayers() {
  ['change-fill', 'change-outline'].forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
  });
  if (map.getSource('changes')) map.removeSource('changes');
}

function showComparison() {
  removeComparisonLayers();
  
  const changes = calculateChanges();
  
  if (!changes || changes.length === 0) {
    console.log("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è");
    return;
  }

  map.addSource('changes', {
    type: 'geojson',
    data: { type: 'FeatureCollection', features: changes }
  });

  map.addLayer({
    id: 'change-fill',
    type: 'fill',
    source: 'changes',
    paint: {
      'fill-color': ['get', 'fillColor'],
      'fill-opacity': 0.7
    }
  });

  map.addLayer({
    id: 'change-outline',
    type: 'line',
    source: 'changes',
    paint: {
      'line-color': ['get', 'fillColor'],
      'line-width': 2,
      'line-dasharray': [2, 2]
    }
  });
}

function calculateChanges() {
  if (!previousDateGeojson || !currentGeojson) return [];

  const prevFeaturesMap = {};
  previousDateGeojson.features.forEach(f => {
    const id = f.id || f.properties.id;
    prevFeaturesMap[id] = turf.cleanCoords(f);
  });
  
  const currFeaturesMap = {};
  currentGeojson.features.forEach(f => {
    const id = f.id || f.properties.id;
    currFeaturesMap[id] = turf.cleanCoords(f);
  });

  const changes = [];

  const allIds = [...occupiedIds, ...liberatedIds, ...newLiberatedIds, ...liberatedRus];
  
  for (const id of allIds) {
    if (currFeaturesMap[id] && prevFeaturesMap[id]) {
      try {
        const diff = turf.difference(currFeaturesMap[id], prevFeaturesMap[id]);
        if (diff) {
          changes.push({
            ...currFeaturesMap[id],
            geometry: diff.geometry,
            properties: {
              ...currFeaturesMap[id].properties,
              fillColor: currFeaturesMap[id].properties.fillColor,
              customName: `–ò–∑–º–µ–Ω–µ–Ω–∏–µ (${currFeaturesMap[id].properties.customName})`
            }
          });
        }
      } catch (e) {
        console.error(`–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–∞ ${id}:`, e);
      }
    }
  }

  return changes;
}

function renderUpdates() {
  const content = document.getElementById('notifications-content');
  content.innerHTML = '';

  const groupedUpdates = {};
  updates.forEach(update => {
    const key = `${update.date}_${update.time}`;
    if (!groupedUpdates[key]) {
      groupedUpdates[key] = {
        date: update.date,
        time: update.time,
        changes: []
      };
    }
    groupedUpdates[key].changes.push(...update.changes);
  });

  Object.values(groupedUpdates).forEach(group => {
    const updateContainer = document.createElement('div');
    updateContainer.className = 'update-container';
    
    const header = document.createElement('div');
    header.className = 'update-header';
    
    const dateElement = document.createElement('div');
    dateElement.className = 'update-date';
    dateElement.textContent = group.date;
    
    const timeElement = document.createElement('div');
    timeElement.className = 'update-time';
    timeElement.textContent = group.time;
    
    header.appendChild(dateElement);
    header.appendChild(timeElement);
    updateContainer.appendChild(header);
    
    const textContainer = document.createElement('div');
    textContainer.className = 'update-text';
    
    group.changes.forEach(change => {
      const textNode = document.createTextNode(change.text);
      textContainer.appendChild(textNode);
      
      const cityLink = document.createElement('span');
      cityLink.className = 'city-link';
      cityLink.textContent = change.city;
      
      cityLink.addEventListener('click', (e) => {
        e.preventDefault();
        map.flyTo({
          center: change.coords,
          zoom: change.zoom || 11,
          essential: true
        });
        toggleNotifications();
      });
      
      textContainer.appendChild(cityLink);
    });
    
    updateContainer.appendChild(textContainer);
    content.appendChild(updateContainer);
  });
}

function toggleNotifications() {
  const panel = document.getElementById('notifications-panel');
  const overlay = document.getElementById('notifications-overlay');
  
  if (panel.style.display === 'flex') {
    panel.style.display = 'none';
    overlay.style.display = 'none';
  } else {
    renderUpdates();
    panel.style.display = 'flex';
    overlay.style.display = 'block';
  }
}

function toggleSettings() {
  const panel = document.getElementById('settings-panel');
  const overlay = document.getElementById('settings-overlay');
  
  if (panel.style.display === 'flex') {
    panel.style.display = 'none';
    overlay.style.display = 'none';
  } else {
    panel.style.display = 'flex';
    overlay.style.display = 'block';
  }
}

function changeMapStyle(style) {
  if (mapStyles[style] && currentMapStyle !== style) {
    map.setStyle(mapStyles[style]);
    currentMapStyle = style;
    
    // –ü–æ—Å–ª–µ —Å–º–µ–Ω—ã —Å—Ç–∏–ª—è –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—à–∏ —Å–ª–æ–∏
    map.once('styledata', () => {
      if (currentGeojson) {
        updateMapSource(currentGeojson);
      }
      if (compareActive) {
        showComparison();
      }
    });
  }
}

function openTgChannel() {
  window.open('https://t.me/Voenpole', '_blank');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.getElementById('prev-btn').addEventListener('click', async () => {
  if (currentIndex > 0) {
    currentIndex--;
    await loadCurrentDate();
  }
});

document.getElementById('next-btn').addEventListener('click', async () => {
  if (currentIndex < availableDates.length - 1) {
    currentIndex++;
    await loadCurrentDate();
  }
});

document.getElementById('compare-btn').addEventListener('click', toggleCompare);
document.getElementById('settings-btn').addEventListener('click', toggleSettings);
document.getElementById('notifications-btn').addEventListener('click', toggleNotifications);
document.getElementById('tg-channel-btn').addEventListener('click', openTgChannel);
document.getElementById('close-notifications').addEventListener('click', toggleNotifications);
document.getElementById('notifications-overlay').addEventListener('click', toggleNotifications);
document.getElementById('close-settings').addEventListener('click', toggleSettings);
document.getElementById('settings-overlay').addEventListener('click', toggleSettings);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –∫–∞—Ä—Ç–∞
document.querySelectorAll('.map-style-option').forEach(option => {
  option.addEventListener('click', () => {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    document.querySelectorAll('.map-style-option').forEach(opt => {
      opt.classList.remove('selected');
      opt.querySelector('.style-radio').checked = false;
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    option.classList.add('selected');
    option.querySelector('.style-radio').checked = true;
    
    // –ú–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫–∞—Ä—Ç—ã
    const style = option.getAttribute('data-style');
    changeMapStyle(style);
  });
});

map.on('load', async () => {
  await loadCurrentDate();
  // –£–±—Ä–∞–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
  map.addControl(new maplibregl.ScaleControl({
    maxWidth: 100,
    unit: 'metric'
  }));
});

map.on('error', (e) => {
  if (e.error && e.error.message.includes('Style is not done loading')) {
    return;
  }
  console.error("–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:", e.error);
});
</script>
</body>
</html>














